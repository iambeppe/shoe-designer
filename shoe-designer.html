<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shoe Designer - Crea la tua scarpa dell'empatia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --pink-sand: #f2007d;
            --sunset: #441f72;
            --aquamarine: #2abeb9;
            --sunrays: #ffb511;
            --white-flakes: #ffffff;
            --dark-lava: #1e0023;
        }
        
        body { 
            font-family: 'Ubuntu', sans-serif; 
            background: linear-gradient(135deg, var(--sunrays) 0%, var(--pink-sand) 100%);
        }
        
        .title-font { 
            font-family: 'Permanent Marker', cursive; 
        }
        
        .loading-spinner {
            border: 3px solid rgba(242, 0, 125, 0.3);
            border-top: 3px solid var(--pink-sand);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, var(--sunrays), var(--pink-sand));
        }
        
        .gradient-secondary {
            background: var(--sunset);
        }
        
        .btn-primary {
            background: var(--pink-sand);
            color: var(--white-flakes);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: var(--sunset);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(242, 0, 125, 0.3);
        }
        
        .btn-secondary {
            background: var(--aquamarine);
            color: var(--white-flakes);
        }
        
        .btn-secondary:hover {
            background: var(--sunrays);
        }
        
        .card-shadow {
            box-shadow: 0 20px 40px rgba(30, 0, 35, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="title-font text-5xl font-bold mb-2" style="color: var(--white-flakes); text-shadow: 2px 2px 4px rgba(30, 0, 35, 0.5);">
                Shoe Designer AI
            </h1>
            <p class="text-xl font-medium" style="color: var(--white-flakes);">Crea la tua scarpa dell'empatia personalizzata</p>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm font-medium" style="color: var(--white-flakes);">Step <span id="current-step">1</span> di 5</span>
                <span class="text-sm" style="color: var(--white-flakes); opacity: 0.8;"><span id="progress-percent">20</span>%</span>
            </div>
            <div class="w-full bg-white bg-opacity-30 rounded-full h-3">
                <div id="progress-bar" class="gradient-secondary h-3 rounded-full transition-all duration-500" style="width: 20%"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="card-shadow rounded-2xl p-8 mb-8" style="background-color: var(--white-flakes);">
            <div id="step-content"></div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-between">
            <button id="prev-btn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--white-flakes); color: var(--dark-lava); border: 2px solid var(--aquamarine);">
                ‚Üê Indietro
            </button>
            <button id="next-btn" class="flex items-center gap-2 px-6 py-3 rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed" style="background-color: var(--white-flakes); color: var(--dark-lava); border: 2px solid var(--sunset);">
                Avanti ‚Üí
            </button>
        </div>
    </div>

    <script>
        // Stato dell'applicazione
        let currentStep = 1;
        let selectedGender = 'unisex';
        let selectedModel = null;
        let selectedColors = [];
        let selectedCustomizations = [];
        let customDetail = '';
        let selectedStyle = null;
        let customStyle = '';
        let expandedCategory = null;
        let generatedImage = null;
        let isGenerating = false;

        // Dati dell'applicazione
        const shoeModels = [
            { id: 'sneaker', name: 'Sneaker', emoji: 'üëü' },
            { id: 'ballet', name: 'Ballerina', emoji: 'ü©∞' },
            { id: 'boot', name: 'Stivale', emoji: 'üë¢' },
            { id: 'heel', name: 'Tacco Alto', emoji: 'üë†' },
            { id: 'sandal', name: 'Sandalo', emoji: 'üë°' },
            { id: 'loafer', name: 'Mocassino', emoji: 'üëû' },
            { id: 'oxford', name: 'Oxford', emoji: 'üëî' },
            { id: 'slides', name: 'Ciabatta', emoji: 'ü©¥' }
        ];

        const colorPalette = [
            // Prima fila - Colori brand Lastminute
            { id: 'pink_sand', name: 'Pink Sand', displayName: 'Pink Sand', hex: '#f2007d', aiName: 'pink' },
            { id: 'sunset', name: 'Sunset', displayName: 'Sunset', hex: '#441f72', aiName: 'purple' },
            { id: 'aquamarine', name: 'Aquamarine', displayName: 'Aquamarine', hex: '#2abeb9', aiName: 'teal' },
            { id: 'sunrays', name: 'Sunrays', displayName: 'Sunrays', hex: '#ffb511', aiName: 'yellow' },
            { id: 'white_flakes', name: 'White Flakes', displayName: 'White Flakes', hex: '#ffffff', aiName: 'white' },
            { id: 'dark_lava', name: 'Dark Lava', displayName: 'Dark Lava', hex: '#1e0023', aiName: 'black' },
            
            // Seconda fila - Colori sportivi e complementari
            { id: 'roma_red', name: 'Rosso Roma', displayName: 'Rosso Roma', hex: '#cc0000', aiName: 'red' },
            { id: 'lazio_blue', name: 'Celeste Lazio', displayName: 'Celeste Lazio', hex: '#87ceeb', aiName: 'light blue' },
            { id: 'blue', name: 'Blu', displayName: 'Blu', hex: '#2563eb', aiName: 'blue' },
            { id: 'green_light', name: 'Verde Chiaro', displayName: 'Verde Chiaro', hex: '#10b981', aiName: 'light green' },
            { id: 'green_dark', name: 'Verde Scuro', displayName: 'Verde Scuro', hex: '#047857', aiName: 'dark green' },
            { id: 'orange', name: 'Arancione', displayName: 'Arancione', hex: '#ea580c', aiName: 'orange' },
            
            // Terza fila - Altri colori
            { id: 'brown', name: 'Marrone', displayName: 'Marrone', hex: '#92400e', aiName: 'brown' },
            { id: 'light_blue', name: 'Azzurro Pastello', displayName: 'Azzurro Pastello', hex: '#7dd3fc', aiName: 'light blue' },
            { id: 'gray', name: 'Grigio', displayName: 'Grigio', hex: '#6b7280', aiName: 'gray' },
            { id: 'gold', name: 'Oro', displayName: 'Oro', hex: '#d97706', aiName: 'gold' },
            { id: 'silver', name: 'Argento', displayName: 'Argento', hex: '#9ca3af', aiName: 'silver' },
            { id: 'red', name: 'Rosso', displayName: 'Rosso', hex: '#dc2626', aiName: 'red' },
            
            // Quarta fila - Nuovi colori aggiunti
            { id: 'coral', name: 'Corallo', displayName: 'Corallo', hex: '#ff7f50', aiName: 'coral' },
            { id: 'lavender', name: 'Lavanda', displayName: 'Lavanda', hex: '#e6e6fa', aiName: 'lavender' },
            { id: 'turquoise', name: 'Turchese', displayName: 'Turchese', hex: '#40e0d0', aiName: 'turquoise' },
            { id: 'navy', name: 'Blu Navy', displayName: 'Blu Navy', hex: '#000080', aiName: 'navy blue' },
            { id: 'cream', name: 'Crema', displayName: 'Crema', hex: '#fffdd0', aiName: 'cream' },
            { id: 'burgundy', name: 'Bordeaux', displayName: 'Bordeaux', hex: '#800020', aiName: 'burgundy' }
        ];

        const customizationCategories = [
            {
                id: 'animals',
                name: 'Animali',
                items: [
                    { id: 'cat', name: 'Gattino', emoji: 'üê±' },
                    { id: 'dog', name: 'Cagnolino', emoji: 'üê∂' },
                    { id: 'butterfly', name: 'Farfalla', emoji: 'ü¶ã' },
                    { id: 'unicorn', name: 'Unicorno', emoji: 'ü¶Ñ' },
                    { id: 'wolf', name: 'Lupa', emoji: 'üê∫' },
                    { id: 'eagle', name: 'Aquila', emoji: 'ü¶Ö' }
                ]
            },
            {
                id: 'nature',
                name: 'Natura',
                items: [
                    { id: 'rainbow', name: 'Arcobaleno', emoji: 'üåà' },
                    { id: 'flower', name: 'Fiore', emoji: 'üå∏' },
                    { id: 'star', name: 'Stella', emoji: '‚≠ê' },
                    { id: 'moon', name: 'Luna', emoji: 'üåô' },
                    { id: 'sun', name: 'Sole', emoji: '‚òÄÔ∏è' },
                    { id: 'sea', name: 'Mare', emoji: 'üåä' }
                ]
            },
            {
                id: 'art',
                name: 'Arte',
                items: [
                    { id: 'scream', name: 'Urlo di Munch', emoji: 'üò±' },
                    { id: 'sunflower', name: 'Girasoli Van Gogh', emoji: 'üåª' },
                    { id: 'wave', name: 'Onda di Hokusai', emoji: 'üåä' },
                    { id: 'starry', name: 'Notte Stellata di Van Gogh', emoji: 'üåå' },
                    { id: 'mondrian', name: 'Composition in Red, Blue and Yellow di Mondrian', emoji: 'üî¥' },
                    { id: 'guernica', name: 'Guernica di Picasso', emoji: 'üé®' }
                ]
            },
            {
                id: 'geometric',
                name: 'Geometrico',
                items: [
                    { id: 'stripes', name: 'Righe', emoji: '„Ä∞Ô∏è' },
                    { id: 'dots', name: 'Pois', emoji: '‚ö™' },
                    { id: 'zigzag', name: 'Zigzag', emoji: '‚ö°' },
                    { id: 'chevron', name: 'Chevron', emoji: 'üî∞' },
                    { id: 'triangle', name: 'Triangoli', emoji: 'üî∫' },
                    { id: 'circle', name: 'Cerchi', emoji: '‚≠ï' }
                ]
            },
            {
                id: 'symbols',
                name: 'Simboli',
                items: [
                    { id: 'heart', name: 'Cuore', emoji: 'üíñ' },
                    { id: 'lightning_symbol', name: 'Fulmine', emoji: '‚ö°' },
                    { id: 'peace', name: 'Pace', emoji: '‚òÆÔ∏è' },
                    { id: 'music', name: 'Nota Musicale', emoji: 'üéµ' },
                    { id: 'diamond', name: 'Diamante', emoji: 'üíé' },
                    { id: 'crown', name: 'Corona', emoji: 'üëë' }
                ]
            },
            {
                id: 'food',
                name: 'Cibo',
                items: [
                    { id: 'pizza', name: 'Pizza', emoji: 'üçï' },
                    { id: 'donut', name: 'Ciambella', emoji: 'üç©' },
                    { id: 'cherry', name: 'Ciliegia', emoji: 'üçí' },
                    { id: 'avocado', name: 'Avocado', emoji: 'ü•ë' },
                    { id: 'strawberry', name: 'Fragola', emoji: 'üçì' },
                    { id: 'ice_cream', name: 'Gelato', emoji: 'üç¶' }
                ]
            },
            {
                id: 'energy',
                name: 'Energia & Motivazione',
                items: [
                    { id: 'flame_cool', name: 'Fiamma Cool', emoji: 'üî•' },
                    { id: 'flame_party', name: 'Fiamma Party', emoji: 'üéâ' },
                    { id: 'flame_travel', name: 'Viaggio', emoji: '‚úàÔ∏è' },
                    { id: 'flame_love', name: 'Amore', emoji: 'üíï' },
                    { id: 'rocket', name: 'Razzo', emoji: 'üöÄ' },
                    { id: 'muscle', name: 'Team Building', emoji: 'üí™' }
                ]
            }
        ];

        const styleOptions = [
            { id: 'party', name: 'Party People', description: 'Brillante e festoso' },
            { id: 'umbria', name: 'Ho l\'Umbria nel cuore', description: 'Rustico e autentico' },
            { id: 'animalier', name: 'Animalier', description: 'Pattern animaleschi' },
            { id: 'bohemian', name: 'Artista Boh√©mien', description: 'Creativo e libero' },
            { id: 'london', name: 'London Calling', description: 'Stile britannico' },
            { id: 'minimalist', name: 'Minimalista', description: 'Pulito e essenziale' },
            { id: 'vintage', name: 'Vintage', description: 'Retr√≤ e nostalgico' },
            { id: 'futuristic', name: 'Futuristico', description: 'Tecnologico e moderno' }
        ];

        // Funzioni di utilit√†
        function updateProgress() {
            document.getElementById('current-step').textContent = currentStep;
            document.getElementById('progress-percent').textContent = Math.round((currentStep / 5) * 100);
            document.getElementById('progress-bar').style.width = `${(currentStep / 5) * 100}%`;
        }

        function canGoNext() {
            switch(currentStep) {
                case 1: return selectedModel !== null;
                case 2: return selectedColors.length > 0;
                case 3: return true;
                case 4: return true;
                default: return false;
            }
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            prevBtn.disabled = currentStep === 1;
            nextBtn.disabled = !canGoNext();
            nextBtn.style.display = currentStep === 5 ? 'none' : 'flex';
        }

        // Generazione del prompt
        function generatePrompt() {
            const modelName = shoeModels.find(m => m.id === selectedModel)?.name || 'shoe';
            const colors = selectedColors.map(c => colorPalette.find(color => color.id === c)?.aiName).join(', ');
            
            // Combina personalizzazioni predefinite e custom
            let allCustomizations = selectedCustomizations.map(c => {
                for (const category of customizationCategories) {
                    const item = category.items.find(i => i.id === c);
                    if (item) return item.name;
                }
                return '';
            });
            
            if (customDetail) {
                allCustomizations.push(customDetail);
            }
            
            const customizations = allCustomizations.join(', ');
            const style = selectedStyle ? styleOptions.find(s => s.id === selectedStyle)?.name : customStyle;
            
            // Aggiungi indicazione genere
            const genderText = selectedGender === 'male' ? 'for men' : selectedGender === 'female' ? 'for women' : 'unisex';

            let finalPrompt = `professional photography of a realistic ${modelName} shoe ${genderText}, colors: ${colors}`;
            
            if (customizations) {
                finalPrompt += `, decorations: ${customizations}`;
            }
            
            if (style) {
                finalPrompt += `, style: ${style}`;
            }
            
            finalPrompt += `, side view, neutral background, perfect lighting, high quality, detailed, photorealistic, studio lighting`;
            
            return finalPrompt;
        }

        // Generazione dell'immagine con AI
        async function generateImage() {
            if (isGenerating) return;
            
            isGenerating = true;
            const prompt = generatePrompt();
            
            // Mostra loading
            document.getElementById('step-content').innerHTML = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Generando la tua scarpa...</h2>
                        <p class="text-gray-600">L'AI sta creando la tua scarpa personalizzata</p>
                    </div>
                    <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
                        <div class="loading-spinner mx-auto mb-4"></div>
                        <p class="text-purple-600 font-medium">Chiamata AI in corso...</p>
                        <p class="text-sm text-gray-500 mt-2">Questo pu√≤ richiedere 10-30 secondi</p>
                    </div>
                </div>
            `;

            try {
                // Prova con Pollinations (pi√π affidabile)
                const encodedPrompt = encodeURIComponent(prompt);
                const imageUrl = `https://image.pollinations.ai/prompt/${encodedPrompt}?width=512&height=512&seed=${Math.floor(Math.random() * 1000000)}&model=flux&enhance=true&nologo=true`;
                
                // Testa il caricamento dell'immagine
                await new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = imageUrl;
                    
                    // Timeout di 30 secondi
                    setTimeout(reject, 30000);
                });

                generatedImage = imageUrl;
                renderStep5();
                
            } catch (error) {
                console.error('Errore Pollinations, provo Hugging Face...', error);
                
                try {
                    // Fallback a Hugging Face
                    const response = await fetch('https://api-inference.huggingface.co/models/black-forest-labs/FLUX.1-schnell', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            inputs: prompt,
                            parameters: {
                                width: 512,
                                height: 512,
                                guidance_scale: 7.5,
                                num_inference_steps: 20
                            }
                        })
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        generatedImage = URL.createObjectURL(blob);
                        renderStep5();
                    } else {
                        throw new Error('Hugging Face API error');
                    }
                    
                } catch (hfError) {
                    console.error('Errore Hugging Face:', hfError);
                    
                    // Fallback finale: mostra il prompt per uso manuale
                    document.getElementById('step-content').innerHTML = `
                        <div class="space-y-6">
                            <div class="text-center">
                                <h2 class="text-3xl font-bold text-gray-800 mb-2">Servizio AI temporaneamente non disponibile</h2>
                                <p class="text-gray-600">Ma puoi usare questo prompt con ChatGPT o Gemini!</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h3 class="font-bold text-lg mb-4">Copia questo prompt:</h3>
                                <textarea readonly class="w-full h-32 p-4 border rounded-lg bg-white font-mono text-sm">${prompt}</textarea>
                                <button onclick="navigator.clipboard.writeText('${prompt}')" class="mt-4 px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                    Copia Prompt
                                </button>
                            </div>
                            <div class="text-center text-sm text-gray-600">
                                <p>1. Copia il prompt qui sopra</p>
                                <p>2. Vai su ChatGPT o Gemini</p>
                                <p>3. Incolla il prompt</p>
                                <p>4. Ottieni la tua scarpa personalizzata!</p>
                            </div>
                        </div>
                    `;
                }
            }
            
            isGenerating = false;
        }

        // Render degli step
        function renderStep1() {
            document.getElementById('step-content').innerHTML = `
                <div class="space-y-8">
                    <div class="text-center">
                        <h2 class="title-font text-4xl font-bold mb-2" style="color: var(--sunset);">Scegli il Modello</h2>
                        <p class="text-lg" style="color: var(--dark-lava);">Seleziona il tipo di scarpa e il genere</p>
                    </div>
                    
                    <!-- Modelli di Scarpa -->
                    <div>
                        <h3 class="text-xl font-semibold mb-4 text-center" style="color: var(--sunset);">Tipo di Scarpa</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${shoeModels.map(model => `
                                <button onclick="selectModel('${model.id}')" class="model-btn p-6 rounded-xl border-3 transition-all transform hover:scale-105 hover:shadow-lg ${selectedModel === model.id ? 'border-pink-sand bg-pink-50 shadow-xl' : 'border-gray-200 hover:border-aquamarine'}" data-model="${model.id}" style="${selectedModel === model.id ? 'border-color: var(--pink-sand); background-color: rgba(242, 0, 125, 0.1);' : 'border-color: #e5e7eb;'} border-width: 3px;">
                                    <div class="text-5xl mb-3">${model.emoji}</div>
                                    <div class="font-semibold" style="color: var(--dark-lava);">${model.name}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Selettore Genere -->
                    <div class="text-center">
                        <h3 class="text-xl font-semibold mb-4" style="color: var(--sunset);">Genere</h3>
                        <div class="flex justify-center gap-4">
                            <button onclick="selectGender('male')" class="gender-btn px-6 py-3 rounded-lg border-3 transition-all transform hover:scale-105 ${selectedGender === 'male' ? 'border-pink-sand bg-pink-50 shadow-lg' : 'border-gray-300 hover:border-aquamarine'}" data-gender="male" style="${selectedGender === 'male' ? 'border-color: var(--pink-sand); background-color: rgba(242, 0, 125, 0.1);' : 'border-color: #d1d5db;'} border-width: 3px;">
                                <div class="text-2xl mb-1">üë®</div>
                                <div class="font-semibold" style="color: var(--dark-lava);">Uomo</div>
                            </button>
                            <button onclick="selectGender('female')" class="gender-btn px-6 py-3 rounded-lg border-3 transition-all transform hover:scale-105 ${selectedGender === 'female' ? 'border-pink-sand bg-pink-50 shadow-lg' : 'border-gray-300 hover:border-aquamarine'}" data-gender="female" style="${selectedGender === 'female' ? 'border-color: var(--pink-sand); background-color: rgba(242, 0, 125, 0.1);' : 'border-color: #d1d5db;'} border-width: 3px;">
                                <div class="text-2xl mb-1">üë©</div>
                                <div class="font-semibold" style="color: var(--dark-lava);">Donna</div>
                            </button>
                            <button onclick="selectGender('unisex')" class="gender-btn px-6 py-3 rounded-lg border-3 transition-all transform hover:scale-105 ${selectedGender === 'unisex' ? 'border-pink-sand bg-pink-50 shadow-lg' : 'border-gray-300 hover:border-aquamarine'}" data-gender="unisex" style="${selectedGender === 'unisex' ? 'border-color: var(--pink-sand); background-color: rgba(242, 0, 125, 0.1);' : 'border-color: #d1d5db;'} border-width: 3px;">
                                <div class="text-2xl mb-1">üë•</div>
                                <div class="font-semibold" style="color: var(--dark-lava);">Unisex</div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep2() {
            document.getElementById('step-content').innerHTML = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="title-font text-4xl font-bold mb-2" style="color: var(--sunset);">Scegli i Colori</h2>
                        <p class="text-lg" style="color: var(--dark-lava);">Seleziona da 1 a 4 colori per la tua scarpa</p>
                        <div class="mt-2 text-lg font-semibold" style="color: var(--pink-sand);">
                            ${selectedColors.length}/4 colori selezionati
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-6 gap-3">
                        ${colorPalette.map(color => `
                            <button onclick="toggleColor('${color.id}')" class="color-btn relative w-16 h-16 rounded-lg border-3 transition-all transform hover:scale-110 hover:shadow-lg ${selectedColors.includes(color.id) ? 'border-pink-sand shadow-xl' : 'border-gray-300 hover:border-aquamarine'}" style="background-color: ${color.hex}; ${selectedColors.includes(color.id) ? 'border-color: var(--pink-sand);' : 'border-color: #d1d5db;'} border-width: 3px;" title="${color.displayName}" data-color="${color.id}">
                                ${selectedColors.includes(color.id) ? '<div class="absolute inset-0 flex items-center justify-center"><div style="color: ' + (color.hex === '#ffffff' || color.hex === '#ffb511' || color.hex === '#7dd3fc' || color.hex === '#87ceeb' || color.hex === '#e6e6fa' || color.hex === '#fffdd0' ? 'var(--dark-lava)' : 'var(--white-flakes)') + '; font-size: 24px; font-weight: bold;">‚úì</div></div>' : ''}
                            </button>
                        `).join('')}
                    </div>
                    
                    ${selectedColors.length > 0 ? `
                        <div class="mt-6 p-4 rounded-lg" style="background-color: rgba(242, 0, 125, 0.1); border: 2px solid var(--pink-sand);">
                            <h3 class="font-semibold text-lg mb-2" style="color: var(--sunset);">Colori selezionati:</h3>
                            <div class="flex flex-wrap gap-2">
                                ${selectedColors.map(colorId => {
                                    const color = colorPalette.find(c => c.id === colorId);
                                    return `
                                        <span class="px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2" style="background-color: var(--aquamarine); color: var(--white-flakes);">
                                            <div class="w-4 h-4 rounded-full border-2" style="background-color: ${color.hex}; border-color: var(--white-flakes);"></div>
                                            ${color.displayName}
                                        </span>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStep3() {
            document.getElementById('step-content').innerHTML = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="title-font text-4xl font-bold mb-2" style="color: var(--sunset);">Personalizzazione</h2>
                        <p class="text-lg" style="color: var(--dark-lava);">Aggiungi fino a 3 dettagli lasciandoti ispirare da quelli qui di seguito</p>
                        <div class="mt-2 text-lg font-semibold" style="color: var(--pink-sand);">
                            ${selectedCustomizations.length}/3 dettagli selezionati
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        ${customizationCategories.map(category => `
                            <div class="border-3 rounded-lg overflow-hidden" style="border-color: var(--aquamarine);">
                                <button onclick="toggleCategory('${category.id}')" class="w-full p-4 transition-colors flex items-center justify-between" style="background-color: var(--aquamarine); color: var(--white-flakes);">
                                    <span class="font-semibold">${category.name}</span>
                                    <span class="transform transition-transform text-xl ${expandedCategory === category.id ? 'rotate-90' : ''}">‚ñ∂</span>
                                </button>
                                
                                <div id="category-${category.id}" class="p-2 space-y-2" style="display: ${expandedCategory === category.id ? 'block' : 'none'}; background-color: var(--white-flakes);">
                                    ${category.items.map(item => `
                                        <button onclick="toggleCustomization('${item.id}')" class="w-full p-3 rounded-lg border-2 transition-all text-left ${selectedCustomizations.includes(item.id) ? 'border-pink-sand bg-pink-50' : 'border-gray-200 hover:border-aquamarine'}" style="${selectedCustomizations.includes(item.id) ? 'border-color: var(--pink-sand); background-color: rgba(242, 0, 125, 0.1);' : 'border-color: #e5e7eb;'}">
                                            <div class="flex items-center gap-2">
                                                <span class="text-lg">${item.emoji}</span>
                                                <span class="text-sm font-medium" style="color: var(--dark-lava);">${item.name}</span>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Campo personalizzato -->
                    <div class="mt-8 p-4 rounded-lg" style="background-color: rgba(42, 190, 185, 0.1); border: 2px solid var(--aquamarine);">
                        <h3 class="font-semibold text-lg mb-2" style="color: var(--sunset);">Aggiungi il tuo dettaglio personalizzato</h3>
                        <p class="text-sm mb-3" style="color: var(--dark-lava);">E se vuoi aggiungine tu uno descrivendolo (es. logo della tua squadra di calcio)</p>
                        <input type="text" id="custom-detail" value="${customDetail}" oninput="updateCustomDetail(this.value)" placeholder="Descrivi il tuo dettaglio personalizzato..." class="w-full p-3 border-2 rounded-lg focus:outline-none" style="border-color: var(--aquamarine); color: var(--dark-lava);">
                    </div>

                    <div class="mt-6 text-center">
                        <button onclick="clearCustomizations()" class="px-6 py-2 rounded-lg transition-colors" style="background-color: var(--white-flakes); color: var(--dark-lava); border: 2px solid var(--gray);">
                            Nessuna personalizzazione
                        </button>
                    </div>

                    ${(selectedCustomizations.length > 0 || customDetail) ? `
                        <div class="mt-6 p-4 rounded-lg" style="background-color: rgba(242, 0, 125, 0.1); border: 2px solid var(--pink-sand);">
                            <h3 class="font-semibold text-lg mb-2" style="color: var(--sunset);">Dettagli selezionati:</h3>
                            <div class="flex flex-wrap gap-2">
                                ${selectedCustomizations.map(itemId => {
                                    let item = null;
                                    for (const category of customizationCategories) {
                                        const found = category.items.find(i => i.id === itemId);
                                        if (found) {
                                            item = found;
                                            break;
                                        }
                                    }
                                    return item ? `
                                        <span class="px-4 py-2 rounded-full text-sm font-semibold flex items-center gap-2" style="background-color: var(--sunset); color: var(--white-flakes);">
                                            <span>${item.emoji}</span>
                                            ${item.name}
                                        </span>
                                    ` : '';
                                }).join('')}
                                ${customDetail ? `
                                    <span class="px-4 py-2 rounded-full text-sm font-semibold" style="background-color: var(--sunrays); color: var(--dark-lava);">
                                        ‚ú® ${customDetail}
                                    </span>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderStep4() {
            document.getElementById('step-content').innerHTML = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">Stile</h2>
                        <p class="text-gray-600">Scegli uno stile o creane uno personalizzato</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${styleOptions.map(style => `
                            <button onclick="selectStyle('${style.id}')" class="style-btn p-4 rounded-lg border-2 transition-all text-left ${selectedStyle === style.id ? 'border-purple-500 bg-purple-50' : 'border-gray-200 hover:border-purple-300'}" data-style="${style.id}">
                                <div class="font-medium text-gray-800">${style.name}</div>
                                <div class="text-sm text-gray-600">${style.description}</div>
                            </button>
                        `).join('')}
                    </div>

                    <div class="mt-6">
                        <h3 class="font-medium text-gray-800 mb-2">Oppure scrivi il tuo stile:</h3>
                        <input type="text" id="custom-style" value="${customStyle}" oninput="updateCustomStyle(this.value)" placeholder="Descrivi il tuo stile personalizzato..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>

                    <div class="mt-6">
                        <button onclick="clearStyle()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                            Nessuno stile specifico
                        </button>
                    </div>
                </div>
            `;
        }

        function renderStep5() {
            if (!generatedImage) {
                document.getElementById('step-content').innerHTML = `
                    <div class="space-y-6">
                        <div class="text-center">
                            <h2 class="title-font text-4xl font-bold mb-2" style="color: var(--sunset);">La Tua Scarpa!</h2>
                            <p class="text-lg" style="color: var(--dark-lava);">Pronta per essere generata dall'AI</p>
                        </div>

                        <div class="card-shadow rounded-2xl p-8 text-center" style="background-color: var(--white-flakes);">
                            <div class="text-8xl mb-4">üé®</div>
                            <p class="text-lg mb-6" style="color: var(--dark-lava);">Clicca per generare la tua scarpa con l'AI!</p>
                            <button onclick="generateImage()" class="btn-primary px-8 py-4 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                                üì∏ Genera Scarpa AI
                            </button>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('step-content').innerHTML = `
                    <div class="space-y-6">
                        <div class="text-center">
                            <h2 class="title-font text-4xl font-bold mb-2" style="color: var(--sunset);">La Tua Scarpa!</h2>
                            <p class="text-lg" style="color: var(--dark-lava);">Ecco il risultato della tua personalizzazione</p>
                        </div>

                        <div class="card-shadow rounded-2xl p-8 text-center" style="background-color: var(--white-flakes);">
                            <img src="${generatedImage}" alt="Scarpa personalizzata" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg mb-6">
                            
                            <div class="flex flex-col md:flex-row justify-center gap-4 mt-6">
                                <button onclick="downloadImage()" class="btn-secondary flex items-center justify-center gap-2 px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                                    üì• Scarica
                                </button>
                                <button onclick="generateNewImage()" class="btn-primary flex items-center justify-center gap-2 px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg">
                                    üé® Genera Nuova
                                </button>
                                <button onclick="restartFromBeginning()" class="flex items-center justify-center gap-2 px-6 py-3 rounded-lg transition-all transform hover:scale-105 shadow-lg" style="background-color: var(--sunrays); color: var(--dark-lava);">
                                    üîÑ Ricomincia dall'inizio
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Event handlers
        function selectGender(gender) {
            selectedGender = gender;
            renderStep1();
            updateNavigation();
        }
        
        function selectModel(modelId) {
            selectedModel = modelId;
            document.querySelectorAll('.model-btn').forEach(btn => {
                btn.style.borderColor = '#e5e7eb';
                btn.style.backgroundColor = 'transparent';
            });
            const selectedBtn = document.querySelector(`[data-model="${modelId}"]`);
            selectedBtn.style.borderColor = 'var(--pink-sand)';
            selectedBtn.style.backgroundColor = 'rgba(242, 0, 125, 0.1)';
            updateNavigation();
        }

        function toggleColor(colorId) {
            if (selectedColors.includes(colorId)) {
                selectedColors = selectedColors.filter(c => c !== colorId);
            } else if (selectedColors.length < 4) {
                selectedColors.push(colorId);
            }
            renderStep2();
            updateNavigation();
        }

        function toggleCategory(categoryId) {
            expandedCategory = expandedCategory === categoryId ? null : categoryId;
            renderStep3();
        }

        function toggleCustomization(itemId) {
            if (selectedCustomizations.includes(itemId)) {
                selectedCustomizations = selectedCustomizations.filter(c => c !== itemId);
            } else if (selectedCustomizations.length < 3) {
                selectedCustomizations.push(itemId);
            }
            renderStep3();
        }

        function updateCustomDetail(value) {
            customDetail = value;
        }
        
        function clearCustomizations() {
            selectedCustomizations = [];
            customDetail = '';
            renderStep3();
        }

        function selectStyle(styleId) {
            selectedStyle = styleId;
            customStyle = '';
            renderStep4();
        }

        function updateCustomStyle(value) {
            customStyle = value;
            selectedStyle = null;
            document.querySelectorAll('.style-btn').forEach(btn => {
                btn.className = btn.className.replace('border-purple-500 bg-purple-50', 'border-gray-200 hover:border-purple-300');
            });
        }

        function clearStyle() {
            selectedStyle = null;
            customStyle = '';
            renderStep4();
        }

        function downloadImage() {
            if (generatedImage) {
                const link = document.createElement('a');
                link.download = 'mia-scarpa-personalizzata.png';
                link.href = generatedImage;
                link.click();
            }
        }

        function generateNewImage() {
            generatedImage = null;
            generateImage();
        }
        
        function restartFromBeginning() {
            // Reset di tutto lo stato
            currentStep = 1;
            selectedGender = 'unisex';
            selectedModel = null;
            selectedColors = [];
            selectedCustomizations = [];
            customDetail = '';
            selectedStyle = null;
            customStyle = '';
            expandedCategory = null;
            generatedImage = null;
            isGenerating = false;
            
            // Torna al primo step
            goToStep(1);
        }

        // Navigation
        function goToStep(step) {
            currentStep = step;
            updateProgress();
            updateNavigation();
            
            switch(step) {
                case 1: renderStep1(); break;
                case 2: renderStep2(); break;
                case 3: renderStep3(); break;
                case 4: renderStep4(); break;
                case 5: renderStep5(); break;
            }
        }

        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentStep > 1) {
                goToStep(currentStep - 1);
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            if (currentStep < 5 && canGoNext()) {
                goToStep(currentStep + 1);
            }
        });

        // Inizializzazione
        goToStep(1);
    </script>
</body>
</html>